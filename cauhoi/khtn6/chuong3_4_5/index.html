<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bài tập Trắc nghiệm Khoa học Tự nhiên 6 (Chương 4, 5, 6)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .view {
            display: none;
        }
        .view.active {
            display: block;
        }
        .option-btn {
            transition: all 0.2s ease-in-out;
        }
        .option-btn:hover:not(:disabled) {
             background-color: #f3f4f6; /* bg-gray-100 */
        }
        .option-btn.correct {
            background-color: #22c55e; /* bg-green-500 */
            color: white;
            border-color: #16a34a; /* border-green-600 */
        }
        .option-btn.incorrect {
            background-color: #ef4444; /* bg-red-500 */
            color: white;
            border-color: #dc2626; /* border-red-600 */
        }
        .timer-container {
            display: flex;
            align-items: center;
            font-weight: 600;
            font-size: 1.125rem;
            color: #4b5563; /* text-gray-600 */
        }
        .timer-warning {
            color: #ef4444; /* text-red-500 */
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div id="app" class="w-full max-w-3xl bg-white rounded-2xl shadow-xl p-6 sm:p-8 space-y-6">

        <!-- Home View -->
        <div id="home-view" class="view active">
            <div class="text-center space-y-4">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">Trắc nghiệm KHTN 6</h1>
                <p class="text-gray-600 text-lg">(Chương 4, 5, 6)</p>
                <p class="text-gray-600 text-lg">Chọn hình thức làm bài kiểm tra</p>
            </div>
            <div class="mt-8 grid grid-cols-1 sm:grid-cols-2 gap-6">
                <button id="start-by-chapter-btn" class="w-full text-lg font-semibold py-4 px-6 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 transition-transform transform hover:scale-105">
                    Làm theo Chương
                </button>
                <button id="start-by-lesson-btn" class="w-full text-lg font-semibold py-4 px-6 bg-teal-600 text-white rounded-xl hover:bg-teal-700 focus:outline-none focus:ring-4 focus:ring-teal-300 transition-transform transform hover:scale-105">
                    Làm theo Bài
                </button>
            </div>
        </div>

        <!-- Selection View -->
        <div id="selection-view" class="view">
            <div class="flex items-center justify-between mb-6">
                <button id="back-to-home-btn" class="text-indigo-600 hover:text-indigo-800 font-semibold">&larr; Quay lại</button>
                <h2 id="selection-title" class="text-2xl font-bold text-gray-800"></h2>
            </div>
            <div id="selection-container" class="space-y-4">
                <!-- Content will be generated by JS -->
            </div>
        </div>

        <!-- Quiz View -->
        <div id="quiz-view" class="view">
            <div class="flex justify-between items-center mb-4">
                <h2 id="quiz-title" class="text-xl font-bold text-gray-700"></h2>
                <div class="flex items-center gap-4">
                     <div id="timer-display" class="timer-container">
                        <span>⏱️</span>&nbsp;<span id="time-left">15</span>s
                    </div>
                    <span id="progress-text" class="text-lg font-semibold text-gray-500"></span>
                </div>
            </div>
            <div id="question-container" class="bg-gray-50 p-6 rounded-xl border border-gray-200">
                <p id="question-text" class="text-2xl font-semibold text-gray-800 mb-6"></p>
                <div id="options-container" class="space-y-4">
                    <!-- Options generated by JS -->
                </div>
            </div>
            <div class="mt-6 flex justify-end">
                <button id="next-question-btn" class="py-3 px-8 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-opacity-75 disabled:opacity-50 disabled:cursor-not-allowed" disabled>Câu tiếp theo</button>
            </div>
        </div>

        <!-- Result View -->
        <div id="result-view" class="view">
            <div class="text-center space-y-4">
                <h2 class="text-3xl font-bold text-gray-800">Kết Quả</h2>
                <p id="score-text" class="text-5xl font-bold text-indigo-600"></p>
                <p id="result-message" class="text-2xl font-semibold"></p>
            </div>
            <div class="mt-8 grid grid-cols-1 sm:grid-cols-2 gap-4">
                <button id="retry-btn" class="w-full text-lg font-semibold py-3 px-6 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">Làm lại</button>
                <button id="home-btn" class="w-full text-lg font-semibold py-3 px-6 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-400">Trang chủ</button>
            </div>
        </div>

    </div>

    <script>
        const questionBank = {
            chapters: [
                {
                    id: 4,
                    title: "Chương 4. Hỗn hợp. Tách chất ra khỏi hỗn hợp",
                    lessons: [
                        {
                            id: 16,
                            title: "Bài 16. Hỗn hợp các chất",
                            questions: [
                                { question: "Chất tinh khiết là", options: ["có tính chất thay đổi tùy thuộc vào thành phần.", "có tính chất khó xác định.", "chỉ có một chất duy nhất.", "chứa từ hai chất trở lên."], answer: 2 },
                                { question: "Cho các vật thể: áo sơ mi, bút chì, đôi giày, viên kim cương. Vật thể chỉ chứa một chất duy nhất là", options: ["Viên kim cương.", "Áo sơ mi.", "Bút chì.", "Đôi giày."], answer: 0 },
                                { question: "Trường hợp nào sau đây là chất tinh khiết?", options: ["Nước cam.", "Nước biển.", "Muối.", "Bột canh."], answer: 2 },
                                { question: "Hỗn hợp chứa", options: ["từ 2 chất trở lên.", "một chất duy nhất.", "một hoặc hai chất.", "không có chất nào."], answer: 0 },
                                { question: "Những vật thể nào dưới đây là hỗn hợp?", options: ["Nước chanh, gang, thép.", "Thép, nước đường, muối.", "Đinh sắt, oxygen, nước tinh khiết.", "Nước cam, thìa bạc, không khí."], answer: 0 },
                                { question: "Nước tự nhiên là", options: ["một đơn chất.", "một hợp chất.", "một chất tinh khiết.", "một hỗn hợp."], answer: 3 },
                                { question: "Để phân biệt chất tinh khiết và hỗn hợp ta dựa vào", options: ["thể của chất.", "mùi vị của chất.", "tính chất của chất.", "số chất tạo nên."], answer: 3 },
                                { question: "Hỗn hợp nào dưới đây là dung dịch?", options: ["Hỗn hợp nước và dầu ăn.", "Hỗn hợp nước và đường.", "Hỗn hợp nước và cát.", "Hỗn hợp nước và bột mì."], answer: 1 },
                                { question: "Chất nào có thể tan trong nước để tạo thành dung dịch?", options: ["Chất rắn.", "Chất rắn và chất khí.", "Chất lỏng và chất khí.", "Chất rắn, chất lỏng và chất khí."], answer: 3 },
                                { question: "Điểm khác nhau giữa nước cất và nước tự nhiên là", options: ["nước cất không màu, nước tự nhiên màu đục.", "nước cất không mùi, nước tự nhiên có mùi.", "nước cất không vị, nước tự nhiên có vị.", "nước cất có một chất, nước tự nhiên có nhiều chất."], answer: 3 },
                                { question: "Dung dịch là hỗn hợp đồng nhất của", options: ["dung môi và chất tan.", "chất rắn phân tán lơ lửng trong chất lỏng.", "đá vôi và nước.", "các giọt chất lỏng lơ lửng trong một chất lỏng khác."], answer: 0 },
                                { question: "Khi pha muối vào nước ta thu được hỗn hợp", options: ["không đồng nhất.", "đồng nhất.", "không hoà tan.", "hoà tan."], answer: 1 },
                                { question: "Khi hòa tan đường vào nước ta thu được", options: ["dung dịch nước đường.", "Nhũ tương.", "giấm.", "huyền phù."], answer: 0 },
                                { question: "Hỗn hợp nào sau đây không được xem là dung dịch?", options: ["Hỗn hợp nước muối.", "Hỗn hợp nước đường.", "Hỗn hợp nước và rượu.", "Hỗn hợp cát và nước."], answer: 3 },
                                { question: "Huyền phù gồm các hạt chất rắn phân tán lơ lửng trong", options: ["chất rắn.", "chất lỏng.", "chất khí.", "gỗ."], answer: 1 },
                                { question: "Khi cho bột mì vào nước và khuấy đều, ta thu được", options: ["dung dịch.", "dung môi.", "huyền phù.", "nhũ tương."], answer: 2 },
                                { question: "Khi hòa tan bột đá vôi vào nước, chỉ một lượng chất này tan trong nước, phần còn lại làm cho nước vôi trong bị đục. Hỗn hợp này được gọi là", options: ["dung dịch.", "huyền phù.", "nhũ tương.", "chất tan."], answer: 1 },
                                { question: "Khi cho bột sắn dây vào nước và khuấy đều, ta thu được", options: ["huyền phù.", "dung dịch.", "dung môi.", "nhũ tương."], answer: 0 },
                                { question: "Hỗn hợp nào dưới dây là huyền phù khi được khuấy trộn?", options: ["Hỗn hợp nước và cát.", "Hỗn hợp nước và đường.", "Hỗn hợp nước và muối.", "Hỗn hợp nước và dầu ăn."], answer: 0 },
                                { question: "Hỗn hợp gồm các giọt chất lỏng lơ lửng trong một chất lỏng khác gọi là", options: ["Dung dịch.", "Dung môi.", "Huyền phù.", "Nhũ tương."], answer: 3 },
                                { question: "Hai chất lỏng không hòa tan vào nhau nhưng khi chịu tác động, chúng lại phân tán vào nhau thì được gọi là", options: ["Chất tinh khiết.", "Dung dịch.", "Nhũ tương.", "Huyền phù."], answer: 2 },
                                { question: "Hỗn hợp nào dưới dây là nhũ tương khi được khuấy trộn?", options: ["Hỗn hợp nước và bột mì.", "Hỗn hợp nước và cát.", "Hỗn hợp nước và dầu ăn.", "Hỗn hợp nước và đường."], answer: 2 },
                                { question: "Khi pha dầu ăn vào nước ta thu được hỗn hợp", options: ["không đồng nhất.", "đồng nhất.", "không hoà tan.", "hoà tan."], answer: 0 },
                                { question: "Hỗn hợp thu được khi cho dầu ăn vào giấm và khuấy đều là", options: ["dung dịch.", "huyền phù.", "dung môi.", "nhũ tương."], answer: 3 },
                                { question: "Chất rắn nào sau đây không tan trong nước?", options: ["Muối ăn.", "Calcium carbonate (đá vôi).", "Đường.", "Viên C sủi."], answer: 1 },
                                { question: "Chất nào tan tốt nhất trong nước nóng?", options: ["Chất lỏng và chất khí.", "Chất khí.", "Chất rắn và chất khí.", "Chất rắn."], answer: 3 },
                                { question: "Chất nào sau đây tan nhiều trong nước nóng?", options: ["Muối ăn.", "Nến.", "Dầu ăn.", "Khí carbon dioxide."], answer: 0 },
                                { question: "Muốn pha cà phê hòa tan nhanh hơn, ta nên sử dụng nước có nhiệt độ như thế nào?", options: ["Nước nóng.", "Nước lạnh.", "Nước ấm.", "Nước ở nhiệt độ phòng."], answer: 0 },
                                { question: "Hỗn hợp nào sau đây không được xem là dung dịch?", options: ["Hỗn hợp nước đường.", "Hỗn hợp nước muối.", "Hỗn hợp nước và rượu.", "Hỗn hợp bột mì và nước khuấy đều."], answer: 3 },
                                { question: "Muốn hoà tan được nhiều muối ăn vào nước, ta không nên sử dụng phương pháp nào dưới đây?", options: ["Nghiền nhỏ muối ăn.", "Đun nóng nước.", "Bỏ thêm đá lạnh vào.", "Vừa cho muối ăn vào nước vừa khuấy đều."], answer: 2 },
                                { question: "Khi tăng nhiệt độ thì độ tan của các chất rắn trong nước thay đổi như thế nào?", options: ["Đều giảm.", "Đều tăng.", "Không thay đổi.", "Phần lớn là tăng."], answer: 3 },
                                { question: "Muốn hòa tan nhanh đường phèn (đường kết tinh dạng viên lớn) vào nước, ta dùng biện pháp nào sau đây?", options: ["Nghiền nhỏ đường phèn.", "Cho thêm đường vào.", "Làm lạnh dung dịch.", "Dùng mảng đường to."], answer: 0 },
                            ]
                        },
                        {
                            id: 17,
                            title: "Bài 17. Tách chất ra khỏi hỗn hợp",
                            questions: [
                                { question: "Điền từ còn thiếu vào câu sau: Hỗn hợp trong tự nhiên đều là hỗn hợp của hai hay nhiều chất khác nhau. Do nhu cầu sử dụng nên quá trình………trong đời sống và công nghệ hoá học là rất cần thiết.", options: ["phân chia.", "tách chất.", "lọc hoá.", "loại bỏ tạp chất."], answer: 1 },
                                { question: "Có thể tách các chất trong hỗn hợp dựa trên", options: ["nồng độ các chất có trong dung dịch.", "hòa tan về tính chất của chúng.", "sự khác nhau về tính chất của chúng.", "khối lượng và thể tích của chúng."], answer: 2 },
                                { question: "Đâu là quá trình tách chất trong tự nhiên và trong đời sống?", options: ["Làm bay hơi muối biển, thu được muối ăn.", "Phù sa trong nước sông lắng xuống, tách khỏi nước", "Đãi vàng từ đất cát trong quặng vàng.", "Cả 3 đáp án trên."], answer: 3 },
                                { question: "Tác dụng chủ yếu của việc đeo khẩu trang là gì?", options: ["Tách oxygen ra khỏi không khí hít vào.", "Tách khí carbon dioxide ra khỏi không khí hít vào.", "Tách hơi nước ra khỏi không khí hít vào.", "Tách khói bụi ra khỏi không khí hít vào."], answer: 3 },
                                { question: "Lắng là phương pháp dùng để tách các chất rắn lơ lửng nặng hơn ra khỏi", options: ["các chất nhẹ hơn.", "các chất nặng hơn.", "các chất tan trong nước.", "các chất dễ bay hơi."], answer: 0 },
                                { question: "Gạn là đổ khẽ để lấy phần chất lỏng trong (nước trong) và", options: ["để lại hỗn hợp hòa tan.", "để lại chất khí.", "để lại chất lỏng.", "để lại chất rắn (cặn)."], answer: 3 },
                                { question: "Phương pháp nào dưới đây là đơn giản nhất để tách cát lẫn trong nước?", options: ["Chiết.", "Lọc.", "Cô cạn.", "Dùng máy li tâm."], answer: 1 },
                                { question: "Hỗn hợp nào dưới đây có thể tách riêng các chất khi cho hỗn hợp vào nước, sau đó khuấy kĩ và lọc?", options: ["Bột đá vôi và muối ăn.", "Bột sắt và muối ăn.", "Đường và muối.", "Giấm và rượu."], answer: 0 },
                                { question: "Trong máy lọc nước có rất nhiều lõi lọc khác nhau. Trong đó có một lõi làm bằng bông được ép rất chặt. Theo em, lõi bông đó có tác dụng gì?", options: ["không có tác dụng gì.", "Lọc hoá chất độc hại.", "Lọc chất tan trong nước.", "Lọc chất không tan trong nước."], answer: 3 },
                                { question: "Để tách muối ra khỏi dung dịch nước muối ta thường dùng phương pháp?", options: ["Cô cạn.", "Tách.", "Lọc.", "Chưng cất."], answer: 0 },
                                { question: "Những người làm muối thường phơi nước biển trên ruộng cát cho đến khi thu được nước muối đậm đặc, sau đó bơm nước muối đậm đặc này lên ruộng xi măng, phơi tiếp thì thu được muối rắn. Hỏi trong cách này đã dùng phương pháp tách chất nào?", options: ["Cô cạn.", "Lọc.", "Chiết.", "Ngưng tụ."], answer: 0 },
                                { question: "Nếu không may làm đổ dầu ăn vào nước, ta dùng phương pháp nào để tách riêng dầu ăn ra khỏi nước?", options: ["Dùng máy li tâm.", "Cô cạn.", "Chiết.", "Lọc."], answer: 2 },
                                { question: "Phương pháp chiết được dùng để tách chất trong hỗn hợp nào sau đây?", options: ["Nước và dầu ăn.", "Bột mì và nước.", "Cát và nước.", "Nước và rượu."], answer: 0 },
                                { question: "Trong quá trình sản xuất tinh dầu từ cây sả, người ta thu được một hỗn hợp gồm lớp tinh dầu xả và nước. Cách tách riêng được lớp tinh dầu sả ra khỏi lớp nước là:", options: ["cô cạn.", "lọc.", "bay hơi.", "chiết."], answer: 3 },
                                { question: "Cách hợp lí nhất để tách muối từ nước biển là:", options: ["Lọc.", "Chưng cất.", "Làm bay hơi nước.", "Để muối lắng xuống rồi gạn đi."], answer: 2 },
                                { question: "Rượu etylic (cồn) sôi ở 78,3oC, nước sôi ở 100oC. Muốn tách rượu ra khỏi hỗn hợp rượu và nước có thể dùng cách nào trong số các cách cho dưới đây?", options: ["Lọc.", "Bay hơi.", "Chưng cất ở nhiệt độ khoảng 80o.", "Không tách được."], answer: 2 },
                                { question: "Khai thác dầu mỏ dưới đáy biển thường thu được hỗn hợp dầu mỏ và nước biển. Người ta dùng phương pháp nào để tách dầu mỏ ra khỏi hỗn hợp? Biết rằng dầu mỏ ít tan trong nước và nhẹ hơn nước.", options: ["Phương pháp lắng, gạn.", "Phương pháp cô cạn.", "Phương pháp lọc.", "Phương pháp chiết."], answer: 3 },
                                { question: "Khi đun canh riêu cua, thấy lớp riêu cua nổi lên trên, có thể hớt lớp riêu cua ra bát bằng thìa. Quá trình này sử dụng phương pháp tách chất nào?", options: ["Lọc.", "Chiết.", "Lắng, gạn.", "Cô cạn."], answer: 2 },
                                { question: "Để tách xăng có lẫn nước, cần sử dụng phương pháp tách chất nào?", options: ["Lắng, gạn.", "Lọc.", "Chiết.", "Cô cạn."], answer: 2 },
                            ]
                        }
                    ]
                },
                {
                    id: 5,
                    title: "Chương 5. Tế bào",
                    lessons: [
                        {
                            id: 18,
                            title: "Bài 18. Tế bào – Đơn vị cơ bản của sự sống",
                            questions: [
                                { question: "Đơn vị cấu tạo nên cơ thể sống gọi là gì?", options: ["Tế bào.", "Mô.", "Bào quan.", "Biểu bì."], answer: 0 },
                                { question: "Nhận định nào sau đây đúng về tế bào?", options: ["Mọi chất đều được cấu tạo từ tế bào.", "Mọi cơ thể sinh vật đều được cấu tạo từ tế bào.", "Mọi đồ vật đều được cấu tạo từ tế bào.", "Mọi vật chất trên trái đất đều được cấu tạo từ tế bào."], answer: 1 },
                                { question: "Vì sao tế bào được xem là đơn vị cơ bản của sự sống?", options: ["Vì tế bào có thể thực hiện đầy đủ các quá trình sống cơ bản.", "Vì tế bào có đầy đủ hết các loại bào quan cần thiết.", "Vì tế bào có nhiều hình dạng khác nhau để thích nghi với các chức năng khác nhau.", "Vì tế bào có nhiều kích thước khác nhau để đảm nhiệm các vai trò khác nhau."], answer: 0 },
                                { question: "Vật nào sau đây có cấu tạo từ tế bào?", options: ["Xe ô tô.", "Cây cầu.", "Cây bạch đàn.", "Ngôi nhà."], answer: 2 },
                                { question: "Các loại tế bào khác nhau thì có hình dạng", options: ["giống nhau.", "khác nhau.", "luôn thay đổi.", "giống nhau và thay đổi như nhau."], answer: 1 },
                                { question: "Nhận định nào đúng khi nói về hình dạng và kích thước tế bào?", options: ["Các loại tế bào đều có chung hình dạng và kích thước.", "Các loại tế bào thường có hình dạng khác nhau nhưng kích thước giống nhau.", "Các loại tế bào khác nhau thường có hình dạng và kích thước khác nhau.", "Các loại tế bào chỉ khác nhau về kích thước, chúng giống nhau về hình dạng."], answer: 2 },
                                { question: "Quan sát tế bào người ta thường sử dụng", options: ["kính hiển vi.", "kính lúp.", "mắt thường.", "kính cận."], answer: 0 },
                                { question: "Trong các tế bào sau, kích thước tế bào lớn nhất là", options: ["tế bào da của voi.", "tế bào trứng cá hồi.", "tế bào xương cá voi.", "tế bào lá cây."], answer: 1 },
                                { question: "Tế bào nào sau đây quan sát bằng kính hiển vi quang học. Chọn câu sai.", options: ["Tế bào vi khuẩn.", "Tế bào trứng ếch.", "Tế bào động vật.", "Tế bào thực vật."], answer: 1 },
                                { question: "Sinh vật nào dưới đây không có cấu tạo tế bào?", options: ["Vi khuẩn.", "Cây me.", "Virus.", "Con mèo."], answer: 2 },
                            ]
                        },
                        {
                            id: 19,
                            title: "Bài 19. Cấu tạo và chức năng các thành phần của tế bào",
                            questions: [
                                { question: "Tế bào được cấu tạo từ các thành phần cơ bản nào?", options: ["Màng tế bào, tế bào chất.", "Màng tế bào, tế bào chất, nhân hoặc vùng nhân.", "Nhân và vật chất di truyền.", "Màng tế bào và vật chất di truyền."], answer: 1 },
                                { question: "Vật chất di truyền nằm ở đâu trong tế bào?", options: ["Nằm lơ lửng ngoài tế bào chất.", "Nằm trong lục lạp.", "Nằm trong nhân hoặc vùng nhân.", "Đính trên màng tế bào."], answer: 2 },
                                { question: "Màng tế bào có vai trò gì?", options: ["Bao bọc tế bào chất và tham gia vào quá trình trao đổi chất giữa tế bào và môi trường.", "Là nơi xảy ra phần lớn các hoạt động trao đổi chất của tế bào.", "Là nơi chứa vật chất di truyền, là trung tâm điều khiển các hoạt động của tế bào.", "Là nơi di chuyển các chất dinh dưỡng đến các cơ quan của cơ thể."], answer: 0 },
                                { question: "Nhân/vùng nhân của tế bào có chức năng gì?", options: ["Tham gia trao đối chất với môi trường.", "Là trung tâm điều khiển mọi hoạt động của tế bào.", "Là nơi diễn ra các hoạt động sống của tế bào.", "Là nơi tạo ra năng lượng cung cấp cho mọi hoạt động của tế bào."], answer: 1 },
                                { question: "Dựa vào đặc điểm cấu tạo tế bào có thể chia tế bào thành hai loại là", options: ["tế bào người và tế bào động vật.", "tế bào mới hình thành và tế bào trưởng thành.", "tế bào nhân sơ và tế bào nhân thực.", "tế bào trung ương và tế bào ngoại biên."], answer: 2 },
                                { question: "Sinh vật nào dưới đây trong cấu tạo tế bào chưa có nhân hoàn chỉnh, chỉ có vùng nhân?", options: ["Cây cam.", "Con gà.", "Cây ổi.", "Vi khuẩn E.coli."], answer: 3 },
                                { question: "Cấu trúc nào của tế bào thực vật chứa sắc tố quang hợp?", options: ["Thành tế bào.", "Không bào.", "Lục lạp.", "Nhân."], answer: 2 },
                                { question: "Thành tế bào có ở loại tế bào nào dưới đây?", options: ["Tế bào nhân sơ.", "Tế bào động vật.", "tế bào thực vật.", "tế bào vi khuẩn."], answer: 2 },
                                { question: "Tế bào động vật khác tế bào thực vật ở điểm nào?", options: ["Đa số không có ti thể.", "Nhân tế bào chưa hoàn chỉnh.", "Có chứa lục lạp.", "Đa số tế bào động vật không có thành tế bào."], answer: 3 },
                                { question: "Màng nhân là cấu trúc không thể quan sát thấy tế bào của nhóm sinh vật nào?", options: ["Động vật.", "Thực vật.", "Người.", "Vi khuẩn."], answer: 3 },
                            ]
                        },
                        {
                            id: 20,
                            title: "Bài 20. Sự lớn lên và sinh sản của tế bào",
                            questions: [
                                { question: "Quá trình nào giúp tế bào lớn lên?", options: ["Hô hấp.", "Nhân đôi.", "Trao đổi chất.", "Tất cả các phương án trên."], answer: 2 },
                                { question: "Khi tế bào lớn lên đến một kích thước nhất định sẽ tiến hành quá trình nào?", options: ["Sinh trưởng.", "Sinh sản.", "Thay thế.", "Chết."], answer: 1 },
                                { question: "Việc phân chia trong tế bào giúp cơ thể.", options: ["Cơ thể lớn lên và sinh sản.", "Cung cấp năng lượng cho cơ thể hoạt động.", "Cơ thể phản ứng với kích thích.", "Cơ thể bào tiết CO2."], answer: 0 },
                                { question: "Quá trình phân chia của tế bào gồm 2 giai đoạn là", options: ["phân chia nhân và phân chia tế bào chất.", "phân chia nhân và phân chia ribosome.", "phân chia nhân và phân chia lục lạp.", "phân chia tế bào chất và phân chia màng tế bào."], answer: 0 },
                                { question: "Một tế bào sau khi trải qua 4 lần sinh sản liên tiếp sẽ tạo ra tất cả bao nhiêu tế bào con?", options: ["4 tế bào.", "8 tế bào.", "12 tế bào.", "16 tế bào."], answer: 3 },
                                { question: "Các tế bào con được sinh ra qua mỗi lần phân chia có đặc điểm gì?", options: ["Các tế bào con giống nhau và giống tế bào mẹ.", "Các tế bào con có hình dạng và kích thước lớn hơn tế bào mẹ.", "Các tế bào con có cấu tạo hoàn thiện hơn tế bào mẹ.", "Các tế bào con có kích thước và hình dạng khác nhau."], answer: 0 },
                                { question: "Sự lớn lên và sinh sản của tế bào có ý nghĩa gì?", options: ["Tăng kích thước của sinh vật, thay thế các tế bào già, chết và các tế bào bị tổn thương.", "Tăng kích thước của cơ thể sinh vật.", "Khiến cho sinh vật già đi.", "Ngăn chặn sự xâm nhập của các yếu tố từ bên ngoài vào cơ thể."], answer: 0 },
                                { question: "Đâu không phải ví dụ của sự lớn lên và sinh sản tế bào?", options: ["Sự cụp lá của cây xấu hổ.", "Sự tăng kích thước của củ khoai.", "Sự lớn lên của em bé.", "Sự tăng kích thước của bắp cải."], answer: 0 },
                                { question: "Vì sao khi thằn lằn bị đứt đuôi, đuôi của nó có thể tái sinh?", options: ["Bởi vì tế bào ở đuôi thằn lằn lớn lên và sinh sản.", "Bởi thằn lằn ăn đuôi của con khác cùng loài.", "Bởi vì thằn lằn có 1 cái đuôi dự phòng.", "Cả ba đáp án trên đều sai."], answer: 0 },
                                { question: "Điều gì xảy ra với các tế bào trong cơ thể khi cơ thể ngừng lớn?", options: ["Các tế bào trong cơ thể dừng sinh trưởng và sinh sản.", "Các tế bào trong cơ thể ngừng sinh trưởng nhưng vẫn sinh sản.", "Các tế bào trong cơ thể ngừng sinh sản nhưng vẫn sinh trưởng.", "Các tế bào trong cơ thể vẫn tiếp tục sinh trưởng và sinh sản."], answer: 3 },
                            ]
                        }
                    ]
                },
                {
                    id: 6,
                    title: "Chương 6. Từ tế bào tới cơ thể",
                    lessons: [
                        {
                            id: 22,
                            title: "Bài 22. Cơ thể sinh vật",
                            questions: [
                                { question: "Cơ thể sinh vật có khả năng thực hiện các quá trình sống cơ bản nào?\n(1) Cảm ứng và vận động. (2) Sinh trưởng. (3) Dinh dưỡng. (4) Hô hấp. (5) Bài tiết. (6) Sinh sản.", options: ["(2), (3), (4), (6).", "(1), (3), (5), (6).", "(2), (3), (4), (5), (6).", "(1), (2), (3), (4), (5), (6)."], answer: 3 },
                                { question: "Cơ thể đơn bào là cơ thể có cấu tạo", options: ["một tế bào.", "hai tế bào.", "hàng trăm tế bào.", "hàng nghìn tế bào."], answer: 0 },
                                { question: "Cơ thể nào dưới đây là cơ thể đơn bào?", options: ["Con chó.", "Trùng biến hình.", "Con ốc sên.", "Con cua."], answer: 1 },
                                { question: "Cơ thể đa bào", options: ["cấu tạo từ 1 tế bào.", "cấu tạo từ 1 tế bào nhân thực.", "cấu tạo từ nhiều tế bào.", "chủ yếu cấu tạo từ các tế bào nhân sơ."], answer: 2 },
                                { question: "Cơ thể đơn bào và cơ thể đa bào khác nhau chủ yếu ở điểm nào?", options: ["Màu sắc.", "Kích thước.", "Số lượng tế bào tạo thành.", "Hình dạng."], answer: 2 },
                                { question: "Tùy thuộc vào số lượng tế bào cấu tạo nên cơ thể chia làm 2 nhóm lớn là", options: ["cơ thể đơn bào và cơ thể đa bào.", "cơ thể động vật và cơ thể thực vật.", "cơ thể lớn lên và cơ thể tí hon.", "cơ thể sinh vật nhân sơ và sinh vật nhân chuẩn."], answer: 0 },
                                { question: "Tế bào cấu tạo nên cơ thể đơn bào", options: ["không có chức năng sinh sản.", "có kích thước siêu hiển vi.", "chưa có cấu tạo hoàn chỉnh.", "thực hiện được chức năng của một cơ thể sống."], answer: 3 },
                                { question: "Cơ thể đa bào là", options: ["cơ thể có kích thước lớn.", "cơ thể được cấu tạo từ nhiều tế bào.", "cơ thể có kích thước nhỏ.", "cơ thể được cấu tạo từ một tế bào."], answer: 1 },
                                { question: "Các quá trình sống cơ bản của cơ thể là", options: ["hô hấp, dinh dưỡng, cảm ứng và vận động, sinh trưởng, sinh sản và bài tiết.", "hô hấp, tuần hoàn, bài tiết, cảm ứng và vận động, sinh sản.", "hô hấp, trao đổi chất, sinh sản và sinh trưởng.", "sinh trưởng, sinh sản, cảm ứng và vận động."], answer: 0 },
                                { question: "Quá trình cơ thể sinh vật lớn lên về kích thước và khối lượng được gọi là", options: ["tiêu hóa.", "bài tiết.", "sinh trưởng.", "hô hấp."], answer: 2 },
                            ]
                        },
                        {
                            id: 23,
                            title: "Bài 23. Tổ chức cơ thể đa bào",
                             questions: [
                                { question: "Cấp độ thấp nhất hoạt động độc lập trong cơ thể đa bào là", options: ["hệ cơ quan.", "cơ quan.", "mô.", "tế bào."], answer: 3 },
                                { question: "Nhóm các tế bào cùng thực hiện một chức năng liên kết với nhau tạo thành", options: ["mô.", "cơ quan.", "hệ cơ quan.", "cơ thể"], answer: 0 },
                                { question: "Tập hợp các mô thực hiện cùng một chức năng nhất định tạo thành", options: ["Hệ cơ quan.", "mô.", "cơ quan.", "tế bào."], answer: 2 },
                                { question: "Các cơ quan ở thực vật là", options: ["rễ, thân, lá, hoa, quả, hạt.", "dạ dày, ruột gan, tim, phổi, mắt, mũi.", "hệ tuần hoàn, hệ hô hấp.", "Hệ rễ và hệ bài tiết."], answer: 0 },
                                { question: "Hệ tuần hoàn được cấu tạo bởi các cơ quan nào sau đây?", options: ["Tim và máu.", "Tim và hệ mạch.", "Hệ mạch và máu.", "Tim, máu và hệ mạch."], answer: 1 },
                                { question: "Nhiều cơ quan cùng phối hợp hoạt động để thực hiện một quá trình sống nào đó của cơ thể gọi là", options: ["hệ cơ quan.", "mô.", "cơ quan.", "tế bào."], answer: 0 },
                                { question: "Hệ cơ quan ở thực vật bao gồm", options: ["hệ rễ và hệ thân.", "hệ thân và hệ lá.", "hệ chồi và hệ rễ.", "hệ cơ và hệ thân."], answer: 2 },
                                { question: "Đâu là trình từ sắp xếp các cấp tổ chức của cơ thể đa bào theo thứ tự từ nhỏ đến lớn?", options: ["Tế bào - cơ quan - hệ cơ quan - cơ thể - mô.", "Mô - tế bào - hệ cơ quan - cơ quan - cơ thể.", "Tế bào - mô - cơ quan - hệ cơ quan - cơ thể.", "Cơ thể - hệ cơ quan - cơ quan - tế bào – mô."], answer: 2 },
                                { question: "Con cá vàng là cấp độ tổ chức nào của cơ thể đa bào?", options: ["Tế bào.", "Cơ thể.", "Cơ quan.", "Mô."], answer: 1 },
                                { question: "Đâu không phải tên một cấp độ tổ chức của cơ thể?", options: ["Thành tế bào.", "Mô.", "Tế bào.", "Hệ cơ quan."], answer: 0 },
                            ]
                        },
                         {
                            id: 25,
                            title: "Bài 25. Hệ thống phân loại sinh vật",
                            questions: [
                                { question: "Phân loại sinh học là sự sắp xếp các đối tượng sinh vật có những đặc điểm chung vào từng nhóm", options: ["theo một thứ tự nhất định.", "theo tên khả năng thay đổi màu sắc.", "theo độ khó của di chuyển.", "theo sự phân chia lãnh thổ."], answer: 0 },
                                { question: "Vì sao cần phải phân loại thế giới sống?", options: ["Để đặt và gọi tên các loài sinh vật khi cần thiết.", "Để xác định số lượng các loài sinh vật trên Trái Đất.", "Để xác định vị trí của các loài sinh vật giúp cho việc tìm ra chúng giữa các sinh vật trở nên dễ dàng hơn.", "Để thấy được sự khác nhau giữa các loài sinh vật."], answer: 2 },
                                { question: "Các bậc phân loại sinh vật từ thấp đến cao theo trình tự nào sau đây?", options: ["Loài → Chi (giống) → Họ → Bộ → Lớp → Ngành → Giới.", "Chi (giống) → Loài → Họ → Bộ → Lớp → Ngành → Giới.", "Giới → Ngành → Lớp → Bộ → Họ → Chi (giống) → Loài.", "Loài → Chi (giống) → Bộ → Họ → Lớp → Ngành → Giới."], answer: 0 },
                                { question: "Đâu là bậc phân loại thấp nhất?", options: ["Giống.", "Loài.", "Bộ.", "Họ."], answer: 1 },
                                { question: "Đâu là bậc phân loại lớn nhất?", options: ["Giới.", "Giống.", "Ngành.", "Họ."], answer: 0 },
                                { question: "Mỗi loài sinh vật thường có hai cách gọi tên là", options: ["tên góc và tên phụ.", "tên giống và tên loài.", "tên địa phương và tên khoa học.", "tên vùng miền và tên địa phương."], answer: 2 },
                                { question: "Hệ thống phân loại sinh vật bao gồm các giới nào?", options: ["Động vật, Thực vật, Nấm.", "Nấm, Nguyên sinh, Thực vật, Virus.", "Khởi sinh, Động vật, Thực vật, Nấm, Virus.", "Khởi sinh, Nguyên sinh, Nấm, Thực vật, Động vật."], answer: 3 },
                                { question: "Cấu tạo tế bào nhân thực, cơ thể đa bào, có khả năng quang hợp là đặc điểm của sinh vật thuộc giới nào sau đây?", options: ["Khởi sinh.", "Nguyên sinh.", "Nấm.", "Thực vật."], answer: 3 },
                                { question: "Những sinh vật có cấu tạo tế bào nhân thực, cơ thể đa bài, dị dưỡng, có khả năng di chuyển, môi trường sống rất đa dạng thuộc giới nào?", options: ["Động vật.", "Nguyên sinh.", "Nấm.", "Thực vật."], answer: 0 },
                                { question: "Vi khuẩn lam có cơ thể đơn bào, nhân sơ, có diệp lục và khả năng tự tổng hợp chất hữu cơ. Vi khuẩn lam thuộc giới nào?", options: ["Khởi sinh.", "Nguyên sinh.", "Nấm.", "Thực vật."], answer: 0 },
                            ]
                        },
                        {
                            id: 26,
                            title: "Bài 26. Khóa lưỡng phân",
                            questions: [
                                { question: "Để phân loại các sinh vật thành từng nhóm dựa trên những đặc điểm giống và khác nhau của sinh vật người ta sử dụng", options: ["kính lúp.", "khóa lưỡng phân.", "trực quan.", "kính hiển vi."], answer: 1 },
                                { question: "Khi tiến hành xây dựng khóa lưỡng phân để phân loại một nhóm sinh vật cần tuân thủ theo nguyên tắc nào?", options: ["Từ một tập hợp sinh vật ban đầu tách thành hai nhóm có những đặc điểm đối lập nhau.", "Từ một tập hợp sinh vật ban đầu tách thành hai nhóm có cơ quan di chuyển khác nhau.", "Từ một tập hợp sinh vật ban đầu tách thành hai nhóm có môi trường sống khác nhau.", "Từ một tập hợp sinh vật ban đầu tách thành hai nhóm có kiểu dinh dưỡng khác nhau."], answer: 0 },
                                { question: "Có bao nhiêu bước để xây dựng khoá lưỡng phân?", options: ["4 bước.", "3 bước.", "2 bước.", "5 bước."], answer: 2 },
                                { question: "Sắp xếp các bước xây dựng khoá lưỡng phân sau theo trình tự thích hợp?\n1. Dựa vào đặc điểm đặc trưng nhất để phân chia sinh vật thành hai nhóm.\n2. Xây dựng khóa lưỡng phân hoàn chỉnh.\n3. Xác định đặc điểm đặc trưng của mỗi sinh vật.\n4. Tiếp tục phân chia các nhóm thành 2 nhóm nhỏ hơn cho đến khi mỗi nhóm chỉ còn 1 sinh vật.", options: ["3 – 1 – 2 – 4.", "3 – 1 – 4 – 2.", "3 – 4 – 1 – 2.", "1 – 3 – 4 – 2."], answer: 1 },
                                { question: "Đặc điểm đối lập của con chim gõ kiến và con chim đà điểu là?", options: ["Biết bay và không biết bay.", "Có lông vũ và không có lông vũ.", "Có mỏ và không có mỏ.", "Có cánh và không có cánh."], answer: 0 },
                            ]
                        },
                        {
                            id: 27,
                            title: "Bài 27. Vi khuẩn",
                            questions: [
                                { question: "Vi khuẩn là", options: ["nhóm sinh vật có cấu tạo nhân sơ, kích thước hiển vi.", "nhóm sinh vật có cấu tạo nhân thực, kích thước hiển vi.", "nhóm sinh vật chưa có cấu tạo tế bào, kích thước hiển vi.", "nhóm sinh vật chưa có cấu tạo tế bào, kích thước siêu hiển vi."], answer: 0 },
                                { question: "Vi khuẩn sống ở đâu?", options: ["Chỉ ở dưới nước.", "Chỉ ở trên cạn.", "Chỉ sống trong cơ thể sinh vật khác.", "Ở khắp mọi nơi."], answer: 3 },
                                { question: "Ba loại hình dạng điển hình của vi khuẩn là?", options: ["Hình cầu, hình khối, hình que.", "Hình lăng trụ, hình khối, hình xoắn.", "Hình que, hình xoắn, hình cầu.", "Hình khối, hình que, hình cầu."], answer: 2 },
                                { question: "Vi khuẩn được cấu tạo bởi các thành phần chính nào?", options: ["Thành tế bào, màng tế bào, tế bào chất, vùng nhân.", "Màng tế bào, thành tế bào, roi, lông.", "Vùng nhân, tế bào chất, roi, lông.", "Roi, tế bào chất, màng sinh chất, lông."], answer: 0 },
                                { question: "Vai trò quan trọng nhất của vi khuẩn trong tự nhiên là gì?", options: ["Phân giải xác sinh vật và chất thải động vật.", "Giúp ức chế vi khuẩn có hại, bảo vệ hệ tiêu hóa.", "Sử dụng trong chế biến thực phẩm như sữa chua, dưa muối.", "Sản xuất thuốc kháng sinh."], answer: 0 },
                                { question: "Phát biểu nào dưới đây không đúng khi nói về vai trò của vi khuẩn.", options: ["Nhiều vi khuẩn có ích được sử dụng trong nông nghiệp và công nghiệp chế biến.", "Vi khuẩn được sử dụng trong sản xuất vaccine và thuốc kháng sinh.", "Mọi vi khuẩn đều có lợi cho tự nhiên và đời sống con người.", "Vi khuẩn giúp phân hủy các chất hữu cơ thành các chất vô cơ để cây sử dụng."], answer: 2 },
                                { question: "Nguyên nhân gây bệnh viêm da là?", options: ["Vi khuẩn tả.", "Vi khuẩn tụ cầu vàng.", "Vi khuẩn lao.", "Vi khuẩn lactic."], answer: 1 },
                                { question: "Người mắc bệnh tả có các biểu hiện nào dưới đây?", options: ["Các vùng da bị tổn.", "Chân sưng tấy, nhức, khó đi lại.", "Ho kéo dài, sốt, mệt mỏi.", "Tiêu chảy, nôn, sốt cao."], answer: 3 },
                            ]
                        },
                         {
                            id: 29,
                            title: "Bài 29. Virus",
                            questions: [
                                { question: "Virus là gì?", options: ["Virus là dạng sống có kích thước vô cùng nhỏ bé, không có cấu tạo tế bào, chỉ nhân lên được trong tế bào của sinh vật sống.", "Virus là một loại vi khuẩn lam, sống kí sinh bắt buộc.", "Virus là một tế bào nhân thực, sống cộng sinh.", "Virus là những thực vật có khả năng di chuyển."], answer: 0 },
                                { question: "Virus nào dưới đây kí sinh trên vi khuẩn?", options: ["Virus cúm.", "Thực khuẩn thể.", "Virus viêm gan.", "Virus dại."], answer: 1 },
                                { question: "Đâu là đặc điểm chính của virus?", options: ["Kích thước siêu hiển vi, tồn tại như một dạng sống ngoài tế bào chủ và sống kí sinh nội bào bắt buộc.", "Kích thước siêu hiển vi, tồn tại như một dạng sống ngoài tế bào chủ và sống kí sinh ngoại bào bắt buộc.", "Kích thước siêu hiển vi, tồn tại như một dạng không sống ngoài tế bào chủ và sống kí sinh nội bào bắt buộc.", "Kích thước siêu hiển vi, tồn tại như một dạng không sống ngoài tế bào chủ và sống kí sinh ngoại bào bắt buộc."], answer: 2 },
                                { question: "Virus sống kí sinh nội bào bắt buộc vì chúng:", options: ["Có kích thước hiển vi.", "Có cấu tạo tế bào nhân sơ.", "Chưa có cấu tạo tế bào.", "Có hình dạng không cố định."], answer: 2 },
                                { question: "Virus có các hình dạng chính nào sau đây?", options: ["Dạng xoắn, dạng cầu, dạng que.", "Dạng xoắn, dạng khối, dạng hỗn hợp.", "Dạng khối, dạng que, dạng hỗn hợp.", "Dạng cầu, dạng xoắn, dạng que."], answer: 1 },
                                { question: "Virus corona có hình gì?", options: ["Hình que.", "Hình xoắn.", "Hình hỗn hợp.", "Hình khối."], answer: 3 },
                                { question: "Vật chất di truyền của một virus là?", options: ["ARN và AND.", "ARN và gai glycoprotein.", "ADN hoặc gai glycoprotein.", "ADN hoặc ARN."], answer: 3 },
                                { question: "Đại dịch Ebola xảy ra vào năm 2014 ở đâu?", options: ["Tây Phi.", "Nam Phi.", "Ấn Độ.", "Tây Thái Bình Dương."], answer: 0 },
                                { question: "Trong các bệnh sau đây, bệnh nào do virus gây nên?", options: ["Bệnh kiết lị.", "Bệnh tả.", "Bệnh vàng da.", "Bệnh dại."], answer: 3 },
                                { question: "Biện pháp nào hữu hiệu nhất để phòng bệnh do virus là?", options: ["Có chế độ dinh dưỡng tốt, bảo vệ môi trường sinh thái cân bằng và trong sạch.", "Chăm sóc sức khỏe, nâng cao thể trạng, tập thể dục, sinh hoạt điều độ.", "Đeo khẩu trang khi đi ra ngoài.", "Sử dụng vaccine vào thời điểm phù hợp."], answer: 3 },
                            ]
                        }
                    ]
                }
            ]
        };

        // DOM Elements
        const app = document.getElementById('app');
        const views = document.querySelectorAll('.view');
        const homeView = document.getElementById('home-view');
        const selectionView = document.getElementById('selection-view');
        const quizView = document.getElementById('quiz-view');
        const resultView = document.getElementById('result-view');
        
        const startByChapterBtn = document.getElementById('start-by-chapter-btn');
        const startByLessonBtn = document.getElementById('start-by-lesson-btn');
        const backToHomeBtn = document.getElementById('back-to-home-btn');
        const selectionTitle = document.getElementById('selection-title');
        const selectionContainer = document.getElementById('selection-container');
        
        const quizTitle = document.getElementById('quiz-title');
        const progressText = document.getElementById('progress-text');
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const timeLeftDisplay = document.getElementById('time-left');
        const timerDisplay = document.getElementById('timer-display');
        
        const scoreText = document.getElementById('score-text');
        const resultMessage = document.getElementById('result-message');
        const retryBtn = document.getElementById('retry-btn');
        const homeBtn = document.getElementById('home-btn');

        // State
        let currentQuizQuestions = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let score = 0;
        let lastSelectionMode = 'chapter';
        let lastSelectionId = null;
        let timerInterval = null;

        // Functions
        function showView(viewId) {
            views.forEach(view => view.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function renderSelectionView(mode) {
            lastSelectionMode = mode;
            selectionContainer.innerHTML = '';
            if (mode === 'chapter') {
                selectionTitle.textContent = 'Chọn Chương';
                questionBank.chapters.forEach(chapter => {
                    const btn = document.createElement('button');
                    btn.className = 'w-full text-left text-lg font-medium p-4 bg-gray-100 rounded-lg hover:bg-gray-200 transition';
                    btn.textContent = chapter.title;
                    btn.onclick = () => startQuiz('chapter', chapter.id);
                    selectionContainer.appendChild(btn);
                });
            } else { // mode === 'lesson'
                selectionTitle.textContent = 'Chọn Bài';
                questionBank.chapters.forEach(chapter => {
                    const chapterTitle = document.createElement('h3');
                    chapterTitle.className = 'text-xl font-bold text-gray-700 mt-4 first:mt-0';
                    chapterTitle.textContent = chapter.title;
                    selectionContainer.appendChild(chapterTitle);

                    const lessonList = document.createElement('div');
                    lessonList.className = 'grid grid-cols-1 sm:grid-cols-2 gap-2 mt-2';
                    chapter.lessons.forEach(lesson => {
                        const btn = document.createElement('button');
                        btn.className = 'w-full text-left font-medium p-3 bg-white border border-gray-200 rounded-lg hover:bg-gray-100 transition';
                        btn.textContent = lesson.title;
                        btn.onclick = () => startQuiz('lesson', chapter.id, lesson.id);
                        lessonList.appendChild(btn);
                    });
                    selectionContainer.appendChild(lessonList);
                });
            }
            showView('selection-view');
        }

        function startQuiz(mode, chapterId, lessonId = null) {
            let questionPool = [];
            let title = '';

            if (mode === 'chapter') {
                const chapter = questionBank.chapters.find(c => c.id === chapterId);
                chapter.lessons.forEach(lesson => {
                    questionPool.push(...lesson.questions);
                });
                title = chapter.title;
                lastSelectionId = chapterId;
            } else { // mode === 'lesson'
                const chapter = questionBank.chapters.find(c => c.id === chapterId);
                const lesson = chapter.lessons.find(l => l.id === lessonId);
                questionPool = [...lesson.questions];
                title = lesson.title;
                lastSelectionId = { chapterId, lessonId };
            }

            if (questionPool.length === 0) {
                alert('Không có câu hỏi cho phần này.');
                return;
            }
            
            currentQuizQuestions = shuffleArray(questionPool).slice(0, 20);
            if (currentQuizQuestions.length < 20) {
                 console.warn("Cảnh báo: Không đủ câu hỏi. Bài kiểm tra sẽ có " + currentQuizQuestions.length + " câu hỏi.");
            }
            currentQuestionIndex = 0;
            userAnswers = new Array(currentQuizQuestions.length).fill(null);
            
            quizTitle.textContent = title;
            renderQuestion();
            showView('quiz-view');
        }

        function startTimer() {
            clearInterval(timerInterval);
            let timeLeft = 15;
            timeLeftDisplay.textContent = timeLeft;
            timerDisplay.classList.remove('timer-warning');

            timerInterval = setInterval(() => {
                timeLeft--;
                timeLeftDisplay.textContent = timeLeft;

                if (timeLeft <= 5) {
                    timerDisplay.classList.add('timer-warning');
                }

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                }
            }, 1000);
        }

        function renderQuestion() {
            if (currentQuestionIndex >= currentQuizQuestions.length) {
                calculateAndShowResults();
                return;
            }

            startTimer(); // Start timer for new question

            const question = currentQuizQuestions[currentQuestionIndex];
            progressText.textContent = `Câu ${currentQuestionIndex + 1}/${currentQuizQuestions.length}`;
            questionText.innerHTML = question.question.replace(/\n/g, '<br>');
            optionsContainer.innerHTML = '';

            question.options.forEach((option, index) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn w-full text-left p-4 border-2 border-gray-300 rounded-lg text-lg';
                btn.textContent = `${String.fromCharCode(65 + index)}. ${option}`;
                btn.onclick = () => handleAnswerSelection(index);
                optionsContainer.appendChild(btn);
            });

            nextQuestionBtn.disabled = true;
            if (currentQuestionIndex === currentQuizQuestions.length - 1) {
                nextQuestionBtn.textContent = 'Nộp bài';
            } else {
                nextQuestionBtn.textContent = 'Câu tiếp theo';
            }
        }
        
        function handleAnswerSelection(selectedIndex) {
            clearInterval(timerInterval); // Stop timer when answered

            userAnswers[currentQuestionIndex] = selectedIndex;
            const question = currentQuizQuestions[currentQuestionIndex];
            const correctAnswerIndex = question.answer;

            const optionButtons = optionsContainer.querySelectorAll('.option-btn');
            optionButtons.forEach((btn, index) => {
                btn.disabled = true; // Khóa các đáp án
                
                if (index === correctAnswerIndex) {
                    btn.classList.add('correct');
                } else if (index === selectedIndex) {
                    btn.classList.add('incorrect');
                }
            });
            
            nextQuestionBtn.disabled = false;
        }

        function calculateAndShowResults() {
            clearInterval(timerInterval);
            let correctAnswers = 0;
            for (let i = 0; i < currentQuizQuestions.length; i++) {
                if (userAnswers[i] === currentQuizQuestions[i].answer) {
                    correctAnswers++;
                }
            }
            score = correctAnswers * 0.5;

            scoreText.textContent = `${score}/10`;
            if (score >= 8) {
                resultMessage.textContent = 'Xuất sắc! Bạn đã đạt.';
                resultMessage.className = 'text-2xl font-semibold text-green-600';
            } else {
                resultMessage.textContent = 'Cần cố gắng thêm. Bạn chưa đạt.';
                 resultMessage.className = 'text-2xl font-semibold text-red-600';
            }
            showView('result-view');
        }
        
        // Event Listeners
        startByChapterBtn.addEventListener('click', () => renderSelectionView('chapter'));
        startByLessonBtn.addEventListener('click', () => renderSelectionView('lesson'));
        backToHomeBtn.addEventListener('click', () => {
            clearInterval(timerInterval);
            showView('home-view');
        });
        nextQuestionBtn.addEventListener('click', () => {
            currentQuestionIndex++;
            renderQuestion();
        });
        
        retryBtn.addEventListener('click', () => {
            if (lastSelectionMode === 'chapter') {
                startQuiz('chapter', lastSelectionId);
            } else {
                startQuiz('lesson', lastSelectionId.chapterId, lastSelectionId.lessonId);
            }
        });
        
        homeBtn.addEventListener('click', () => {
            clearInterval(timerInterval);
            showView('home-view');
        });

    </script>
</body>
</html>
